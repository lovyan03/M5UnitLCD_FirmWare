


# M5Stack Unit LCD

## Unit LCD について

 - Unit LCD は ESP32 と ST7789V2 を搭載した I2Cユニットです。
 - 解像度 135 × 240 の IPS パネルを搭載しています。
 - 表示できる色数は ST7789V2 の仕様である RGB666 の 262,144色です。
 - ESP32が I2C通信を担当し、受信内容に基づき メモリ上のフレームバッファに描画を行います。
 - ESP32のメモリ上のフレームバッファの内容は SPI通信のDMA転送によってST7789V2に反映されます。
 - フレームバッファ上では RGB888 の 16,777,216 色で表現されています。


## Unit LCD との通信について

 - Unit LCDへはI2C通信を使用してコマンドの送信およびデータの受信ができます。
 - I2C通信の通信速度は最大400kHzに対応しています。
 - I2C の7bitアドレスは 0x3E が初期値です。CHANGE_ADDRコマンドで変更することができます。
 - コマンドによって必要な送信Byte数が異なります。<br>1Byteで完了するものもあれば、7Byte必要なコマンドもあります。<br>また、通信をSTOPするまで終わらない不定長コマンドもあります。
 - コマンドの送信途中でI2C通信の STOP や RESTART が発生した場合、途切れたコマンドは処理されません。<br>一回の送信シーケンスで最後まで中断せず送信する必要があります。
 - 固定長コマンド送信後には、連続して別のコマンドを送信することができます。
 - 不定長コマンド送信後には、コマンドの終了を示すためにI2C通信の STOP を行う必要があります。
 - NOPコマンドや未定義コマンドを送信すると、I2C通信が STOP するまで通信内容を無視します。
 - I2C通信部と描画処理部は並列動作しているため、描画処理の途中であってもI2C通信を行うことができます。
 - I2C通信内容はESP32のメモリ上のコマンドバッファに蓄積され、これを描画処理部が順次処理します。
 - 広範囲の塗潰しや範囲コピー等、重い処理を大量に送信するとコマンドバッファが溢れる可能性があるため、<br>READ_BUFCOUNTコマンドを使ってバッファの残量を確認する必要があります。


## 描画コマンドについて

 - FILLRECTで任意の範囲を単一色で塗り潰して矩形を描画できます。
 - １ピクセルのみ描画する場合はFILLRECTの代わりにDRAWPIXELを使用できます。
 - 描画色が省略されたコマンドを使用した場合、最後に使用した色が使用されます。
 - CASET、RASETで描画範囲を指定し、WRITE_RAWコマンドで画像データを送信できます。
 - WRITE_RAWの代わりにWRITE_RLEを使用すると、ランレングス圧縮された画像データを送信できます。


## コマンド一覧  

※ 未定義のコマンドはNOP扱いとなります  

| hex|len|   command   | description                            | send params   |
|:--:|:-:|:------------|:---------------------------------------|:--------------|
|0x00|1-∞|NOP          |通信が STOP するまで何もしない          |[0] 0x00<br>[1-∞] 無視される値|
|0x20| 1 |INVOFF       |色反転を解除                            |[0] 0x20       |
|0x21| 1 |INVON        |色反転を有効                            |[0] 0x21       |
|0x22| 2 |BRIGHTNESS   |バックライト輝度設定<br>0:消灯 -  255:全灯|[0] 0x22<br>[1] 明るさ(0-255)|
|0x23| 7 |COPYRECT     |矩形範囲コピー                          |[0] 0x23<br>[1] コピー元 X_Left<br>[2] コピー元 Y_Top<br>[3] コピー元 X_Right<br>[4] コピー元 Y_Bottom<br>[5] コピー先 X_Left<br>[6] コピー先 Y_Top|
|0x2A| 3 |CASET        |X方向の範囲選択                         |[0] 0x2A<br>[1] X_Left<br>[2] X_Right|
|0x2B| 3 |RASET        |Y方向の範囲選択                         |[0] 0x2B<br>[1] Y_Top<br>[2] Y_Bottom|
|0x36| 2 |ROTATE       |描画の向きを設定<br>0:通常 / 1:90° / 2:180° / 3:270°<br>4-7は0-3の上下反転|[0] 0x36<br>[1] 設定値 (0-7)|
|0x38| 2 |SET_POWER    |動作速度設定(電力消費量設定)<br>0:低速 / 1:通常 / 2:高速|[0] 0x38<br>[1] 設定値 (0-2)|
|0x39| 2 |SET_SLEEP    |LCDパネル スリープ設定<br>0:スリープ解除 / 1:スリープ開始|[0] 0x39<br>[1] 設定値 (0-1)|
|0x41|2-∞|WRITE_RAW_8  |RGB332   の画像描画                     |[0] 0x41<br>[1] RGB332<br>通信STOPまで[1]を繰返し
|0x42|3-∞|WRITE_RAW_16 |RGB565   の画像描画                     |[0] 0x42<br>[1-2] RGB565<br>通信STOPまで[1-2]を繰返し
|0x43|4-∞|WRITE_RAW_24 |RGB888   の画像描画                     |[0] 0x43<br>[1-3] RGB888<br>通信STOPまで[1-3]を繰返し
|0x44|5-∞|WRITE_RAW_32 |ARGB8888 の画像描画                     |[0] 0x44<br>[1-4] ARGB8888<br>通信STOPまで[1-4]を繰返し
|0x45|2-∞|WRITE_RAW_A  |A8       の画像描画<br>アルファチャネルのみ送信<br>最後に使用した描画色を利用|[0] 0x45<br>[1] A8<br>通信STOPまで[1]を繰返し
|0x49|3-∞|WRITE_RLE_8  |RGB332   のRLE画像描画                  |[0] 0x49<br>[1-∞] RLEデータ(別項参照)
|0x4A|4-∞|WRITE_RLE_16 |RGB565   のRLE画像描画                  |[0] 0x4A<br>[1-∞] RLEデータ(別項参照)
|0x4B|5-∞|WRITE_RLE_24 |RGB888   のRLE画像描画                  |[0] 0x4B<br>[1-∞] RLEデータ(別項参照)
|0x4C|6-∞|WRITE_RLE_32 |ARGB8888 のRLE画像描画                  |[0] 0x4C<br>[1-∞] RLEデータ(別項参照)
|0x4D|3-∞|WRITE_RLE_A  |A8       のRLE画像描画<br>アルファチャネルのみ送信<br>最後に使用した描画色を利用|[0] 0x4D<br>[1-∞] RLEデータ(別項参照)
|0x50| 1 |RAM_FILL     |記憶している描画色で選択範囲を塗り潰し  |[0] 0x50       |
|0x51| 2 |SET_COLOR_8  |描画色をRGB332で指定                    |[0] 0x51<br>[1] RGB332    |
|0x52| 3 |SET_COLOR_16 |描画色をRGB565で指定                    |[0] 0x52<br>[1-2] RGB565  |
|0x53| 4 |SET_COLOR_24 |描画色をRGB888で指定                    |[0] 0x53<br>[1-3] RGB888  |
|0x54| 5 |SET_COLOR_32 |描画色をARGB8888で指定                  |[0] 0x54<br>[1-4] ARGB8888|
|0x60| 3 |DRAWPIXEL    |ドット描画<br>記憶している描画色を利用  |[0] 0x60<br>[1] X<br>[2] Y<br>
|0x61| 4 |DRAWPIXEL_8  |ドット描画<br>RGB332の1Byteで描画色指定 |[0] 0x61<br>[1] X<br>[2] Y<br>[3] RGB332
|0x62| 5 |DRAWPIXEL_16 |ドット描画<br>RGB565の2Byteで描画色指定 |[0] 0x62<br>[1] X<br>[2] Y<br>[3-4] RGB565
|0x63| 6 |DRAWPIXEL_24 |ドット描画<br>RGB888の3Byteで描画色指定 |[0] 0x63<br>[1] X<br>[2] Y<br>[3-5] RGB888
|0x64| 7 |DRAWPIXEL_32 |ドット描画<br>ARGB8888の4Byteで描画色指定<br>既存の描画内容と透過合成される|[0] 0x64<br>[1] X<br>[2] Y<br>[3-6] ARGB8888
|0x68| 5 |FILLRECT     |矩形描画<br>記憶している描画色を利用    |[0] 0x68<br>[1] X_Left<br>[2] Y_Top<br>[3] X_Right<br>[4] Y_Bottom
|0x69| 6 |FILLRECT_8   |矩形描画<br>RGB332の1Byteで描画色指定   |[0] 0x69<br>[1] X_Left<br>[2] Y_Top<br>[3] X_Right<br>[4] Y_Bottom<br>[5] RGB332
|0x6A| 7 |FILLRECT_16  |矩形描画<br>RGB565の2Byteで描画色指定   |[0] 0x6A<br>[1] X_Left<br>[2] Y_Top<br>[3] X_Right<br>[4] Y_Bottom<br>[5-6] RGB565
|0x6B| 8 |FILLRECT_24  |矩形描画<br>RGB888の3Byteで描画色指定   |[0] 0x6B<br>[1] X_Left<br>[2] Y_Top<br>[3] X_Right<br>[4] Y_Bottom<br>[5-7] RGB888
|0x6C| 9 |FILLRECT_32  |矩形描画<br>ARGB8888の4Byteで描画色指定<br>既存の描画内容と透過合成される|[0] 0x6C<br>[1] X_Left<br>[2] Y_Top<br>[3] X_Right<br>[4] Y_Bottom<br>[5-8] ARGB8888
|0xA0| 4 |CHANGE_ADDR  |I2Cアドレス変更<br>意図しない実行防止のため、<br>[2]は[1]のビット反転値を指定|[0] 0xA0<br>[1] 新しいI2Cアドレス<br>[2] [1]のビット反転値<br>[3] 0xA0


## コマンド一覧 (受信系コマンド)
| hex|len|   command   | description                          | return values    |
|:--:|:-:|:------------|:-------------------------------------|:-----------------|
|0x04| 1 |READ_ID      |IDとファームウェアバージョン<br>4Byte受信|[0] 0x77<br>[1] 0x89<br>[2] メジャーバージョン<br>[3] マイナーバージョン|
|0x09| 1 |READ_BUFCOUNT|コマンドバッファ残量取得<br>値が大きいほど余裕がある<br>連続で読み出すことができる|[0] 受信バッファ残量(0~255)<br>通信STOPまで繰返し受信可|
|0x81| 1 |READ_RAW_8   |RGB332の画像読出し                    |[0]   RGB332<br>通信STOPまで[0]   を繰返し
|0x82| 1 |READ_RAW_16  |RGB565の画像読出し                    |[0-1] RGB565<br>通信STOPまで[0-1] を繰返し
|0x83| 1 |READ_RAW_24  |RGB888の画像読出し                    |[0-2] RGB888<br>通信STOPまで[0-2] を繰返し



## 通信例

##### 例：矩形描画コマンド0x6A を使って X 16～31、Y 32～47の矩形範囲を赤色に塗る

|index| hex | description             |
|:---:|:---:|:------------------------|
|  0  |0x6A |矩形塗潰コマンド(RGB565) |
|  1  |0x10 |X 左端                   |
|  2  |0x20 |Y 上端                   |
|  3  |0x1F |X 右端                   |
|  4  |0x2F |Y 下端                   |
|  5  |0xF8 |色データ(RRRRRGGG)       |
|  6  |0x00 |色データ(GGGBBBBB)       |

コマンド6Ah は合計7Byteのコマンド列になります。
送信途中にI2C通信の STOP や RESTART が発生した場合はコマンドは処理されません。一回の送信シーケンスで最後まで中断せず送信する必要があります。

矩形塗潰しコマンド68h～6Chはいずれも矩形塗潰しができます。
index1～4までは共通ですが、index5以降 色の指定方法はそれぞれ異なります。

コマンド68hの"記憶している色"は、最後に指定された色を再利用することを意味します。
つまり同色の矩形塗潰しを複数回連続して行う場合、最初の矩形塗潰しのみ色指定を行い、以後は68hコマンドを使うことで色指定を省略できます。

コマンド6ChのARGB8888では、アルファチャンネル(透明度)を指定でき、すでに描画されている内容と描画色を合成することができます。

---

##### 例：範囲指定コマンド0x2A/0x2Bと画像送信コマンドを使って X 10～13、Y 14～17の矩形範囲に画像を描画する

|index| hex | description             |
|:---:|:---:|:------------------------|
|  0  |0x2A |X方向の範囲指定コマンド  |
|  1  |0x0A |X 左端(10)               |
|  2  |0x0D |X 右端(13)               |
|  3  |0x2B |Y方向の範囲指定コマンド  |
|  4  |0x0E |Y 上端(14)               |
|  5  |0x11 |Y 下端(17)               |
|  6  |0x43 |画像描画コマンド(RGB888) |
| 7-54| ??  |画像データ(RGB888 ×16)   |

---

##### 例：WRITE_RLEコマンドを使ったRLE(ランレングスエンコーディング)画像の送信

 - RLEの仕様はBMPファイルのRLEをベースにしています。
 - BMPファイルのRLEと異なり、RGB565やRGB888にも使用できます。
 - 最初に同色ピクセルの連続する数(0-255)を送り、続けて色データを送信します。
 - 連続する数に 0 を送った場合はRLEを使わない直接モードになります。
 - 直接モードでは初めにピクセル数(1-255)を送り、続けてピクセル数ぶんの色データを送信します。


|index|  hex | description             |
|:---:|-----:|:------------------------|
|  0  |  0x4A|RLE画像描画コマンド(RGB565)|
|  1  |  0x07|長さ(7ピクセル)          |
| 2-3 |0xF800|赤色                     |
|  4  |  0x00|長さ(0ピクセル)<br>直接モードに切替 |
|  5  |  0x03|直接モード長さ(3ピクセル)|
| 6-7 |0x07E0|緑色                     |
| 8-9 |0x001F|青色                     |
|10-11|0xF800|赤色                     |
| 12  |  0x04|長さ(4ピクセル)          |
|13-14|0x001F|青色                     |

上記の例は以下のように処理されます。
 - index1-3でRLEモードで赤色を7ピクセル描画します。
 - index4-5で直接モードに切替え、3ピクセル描画する指示をします。
 - index6-11で直接モードの3ピクセル分の色を送信し、緑・青・赤を描画します。
 - index11までで3ピクセル分の直接モードが終了するため、index12からはRLEモードに戻ります。
 - index12-14でRLEモードで青色を4ピクセルぶん描画します。


